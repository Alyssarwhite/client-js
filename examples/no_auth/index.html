<!DOCTYPE html>
<html>

  <head>
    <script src='http://code.jquery.com/jquery-2.1.4.min.js'></script>
    <script src='../../../build/fhir-client.js'></script>
    
  </head>

  <body>

    <h1>Hello <span id="patient_name">...</span>!</h1>
    <ul id="med_list"></ul>
    <script>
      function getPatientName (pt) {
          if (pt.name) {
              var names = pt.name.map(function(name) {
                  return name.given.join(" ") + " " + name.family;
              });
              return names.join(" / ");
          } else {
              return "anonymous";
          }
      }

      function getMedicationName (medCodings) {
          var coding = medCodings.find(function(c){
              return c.system == "http://www.nlm.nih.gov/research/umls/rxnorm";
          });
          return coding && coding.display || "Unnamed Medication(TM)";
      }

      function displayPatient (pt) {
          document.getElementById('patient_name').innerHTML = getPatientName(pt);
      }

      function displayError(error) {
          med_list.innerHTML = "<li> " + String(error) + "</li>";
      }

      var med_list = document.getElementById('med_list');

      function displayMedication (medCodings) {
          med_list.innerHTML += "<li> " + getMedicationName(medCodings) + "</li>";
      }

      var client = FHIR.client({
        serverUrl: "https://r2.smarthealthit.org",
        tokenResponse: {
          patient: "c8e705a6-2a35-4d63-82ec-59301842d79d"
        }
      });

      client.patient.read().then(function(pt) {
          displayPatient (pt);

          client.request("/MedicationOrder?patient=" + pt.id, {
              resolveReferences: [ "medicationReference" ],
              graph: true
          }).then(function(data) {
              if (data.entry && data.entry.length) {
                  med_list.innerHTML = "";
                  data.entry.forEach(function(item) {
                      return displayMedication(
                          client.getPath(item, "resource.medicationCodeableConcept.coding") ||
                          client.getPath(item, "resource.medicationReference.code.coding")
                      );
                  });
              }
              else {
                  med_list.innerHTML = "No medications found for the selected patient";
              }
          }, displayError);
      });
  </script>
  </body>


</html>
